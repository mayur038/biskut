<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biskut - Sweet Shop</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üç¨ Biskut</h1>
            <p>Your Sweet Shop Management System</p>
        </div>

        <!-- Alerts -->
        <div id="alertContainer"></div>

        <!-- Authentication Section -->
        <div id="authSection">
            <!-- Login Form -->
            <div id="loginForm" class="card auth-card">
                <h2 class="text-center mb-4">Welcome Back</h2>
                <form id="loginFormElement">
                    <div class="form-group">
                        <label for="loginUsername">Username</label>
                        <input type="text" id="loginUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Sign In</button>
                </form>
                <p class="text-center mt-4">
                    Don't have an account? 
                    <a href="#" id="showRegister" class="link">Create one</a>
                </p>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="card auth-card hidden">
                <h2 class="text-center mb-4">Create Account</h2>
                <form id="registerFormElement">
                    <div class="form-group">
                        <label for="registerUsername">Username</label>
                        <input type="text" id="registerUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="registerRole">Role</label>
                        <select id="registerRole" required>
                            <option value="Customer">Customer</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Account</button>
                </form>
                <p class="text-center mt-4">
                    Already have an account? 
                    <a href="#" id="showLogin" class="link">Sign in</a>
                </p>
            </div>
        </div>

        <!-- Main Application -->
        <div id="mainApp" class="hidden">
            <!-- User Info Bar -->
            <div class="user-bar">
                <div class="user-info">
                    <h3>Welcome, <span id="userName"></span></h3>
                    <p>Role: <span id="userRole"></span></p>
                </div>
                <button id="logoutBtn" class="btn btn-secondary">Sign Out</button>
            </div>

            <!-- Navigation -->
            <div class="nav">
                <button class="nav-item active" data-tab="sweets">All Sweets</button>
                <button class="nav-item" data-tab="search">Search</button>
                <button class="nav-item hidden" data-tab="admin" id="adminTab">Admin</button>
            </div>

            <!-- All Sweets Tab -->
            <div id="sweetsTab" class="tab-content">
                <div class="grid" id="sweetsGrid">
                    <!-- Sweets will be loaded here -->
                </div>
            </div>

            <!-- Search Tab -->
            <div id="searchTab" class="tab-content hidden">
                <div class="search-bar">
                    <div class="search-row">
                        <input type="text" id="searchName" placeholder="Search by name...">
                        <select id="searchCategory">
                            <option value="">All Categories</option>
                            <option value="Chocolate">Chocolate</option>
                            <option value="Candy">Candy</option>
                            <option value="Gummy">Gummy</option>
                            <option value="Hard Candy">Hard Candy</option>
                            <option value="Lollipop">Lollipop</option>
                        </select>
                        <input type="number" id="minPrice" placeholder="Min Price" step="0.01">
                        <input type="number" id="maxPrice" placeholder="Max Price" step="0.01">
                        <button class="btn btn-primary" id="searchBtn">Search</button>
                    </div>
                </div>
                <div class="grid" id="searchResults"></div>
            </div>

            <!-- Admin Tab -->
            <div id="adminTab" class="tab-content hidden">
                <div class="mb-4">
                    <button class="btn btn-primary" id="addSweetBtn">Add New Sweet</button>
                </div>
                <div class="grid" id="adminSweetsGrid"></div>
            </div>
        </div>
    </div>

    <!-- Add Sweet Modal -->
    <div id="addSweetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Sweet</h2>
                <button class="close" type="button">&times;</button>
            </div>
            <form id="addSweetForm">
                <div class="form-group">
                    <label for="sweetName">Name</label>
                    <input type="text" id="sweetName" required>
                </div>
                <div class="form-group">
                    <label for="sweetCategory">Category</label>
                    <select id="sweetCategory" required>
                        <option value="Chocolate">Chocolate</option>
                        <option value="Candy">Candy</option>
                        <option value="Gummy">Gummy</option>
                        <option value="Hard Candy">Hard Candy</option>
                        <option value="Lollipop">Lollipop</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sweetPrice">Price (‚Çπ)</label>
                    <input type="number" id="sweetPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="sweetQuantity">Quantity</label>
                    <input type="number" id="sweetQuantity" min="0" required>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Add Sweet</button>
            </form>
        </div>
    </div>

    <!-- Edit Sweet Modal -->
    <div id="editSweetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Sweet</h2>
                <button class="close" type="button">&times;</button>
            </div>
            <form id="editSweetForm">
                <input type="hidden" id="editSweetId">
                <div class="form-group">
                    <label for="editSweetName">Name</label>
                    <input type="text" id="editSweetName" required>
                </div>
                <div class="form-group">
                    <label for="editSweetCategory">Category</label>
                    <select id="editSweetCategory" required>
                        <option value="Chocolate">Chocolate</option>
                        <option value="Candy">Candy</option>
                        <option value="Gummy">Gummy</option>
                        <option value="Hard Candy">Hard Candy</option>
                        <option value="Lollipop">Lollipop</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editSweetPrice">Price (‚Çπ)</label>
                    <input type="number" id="editSweetPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="editSweetQuantity">Quantity</label>
                    <input type="number" id="editSweetQuantity" min="0" required>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Update Sweet</button>
            </form>
        </div>
    </div>

    <!-- Restock Modal -->
    <div id="restockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Restock Sweet</h2>
                <button class="close" type="button">&times;</button>
            </div>
            <form id="restockForm">
                <input type="hidden" id="restockSweetId">
                <div class="form-group">
                    <label for="restockQuantity">Quantity to Add</label>
                    <input type="number" id="restockQuantity" min="1" required>
                </div>
                <button type="submit" class="btn btn-success btn-full">Restock</button>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000/api';
        let currentUser = null;
        let authToken = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthStatus();
            setupEventListeners();
        });

         function checkAuthStatus() {
            const savedToken = localStorage.getItem('authToken');
            const savedUser = localStorage.getItem('currentUser');
            
            console.log('Checking auth status...');
            console.log('Saved token exists:', !!savedToken);
            console.log('Saved user exists:', !!savedUser);
            
            if (savedToken && savedUser) {
                authToken = savedToken;
                currentUser = JSON.parse(savedUser);
                console.log('Restored user:', currentUser);
                showMainApp();
            } else {
                console.log('No saved auth found, showing login');
            }
        }


        function setupEventListeners() {
            // Auth form toggles
            document.getElementById('showRegister').addEventListener('click', (e) => {
                e.preventDefault();
                showRegister();
            });
            
            document.getElementById('showLogin').addEventListener('click', (e) => {
                e.preventDefault();
                showLogin();
            });

            // Forms
            document.getElementById('loginFormElement').addEventListener('submit', handleLogin);
            document.getElementById('registerFormElement').addEventListener('submit', handleRegister);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Navigation tabs
            document.querySelectorAll('.nav-item').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Search
            document.getElementById('searchBtn').addEventListener('click', performSearch);

            // Admin actions
            document.getElementById('addSweetBtn').addEventListener('click', () => openModal('addSweetModal'));
            document.getElementById('addSweetForm').addEventListener('submit', handleAddSweet);
            document.getElementById('editSweetForm').addEventListener('submit', handleEditSweet);
            document.getElementById('restockForm').addEventListener('submit', handleRestock);

            // Modal close buttons
            document.querySelectorAll('.close').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    closeModal(e.target.closest('.modal').id);
                });
            });

            // Click outside to close modals
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }

        // Utility Functions
         function showAlert(message, type = 'info') {
            console.log(`Alert [${type}]: ${message}`);
            
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.opacity = '0';
            alert.style.transform = 'translateY(-10px)';
            alert.style.transition = 'all 0.3s ease';
            
            container.appendChild(alert);
            
            // Trigger animation
            setTimeout(() => {
                alert.style.opacity = '1';
                alert.style.transform = 'translateY(0)';
            }, 10);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, 300);
            }, 5000);
        }

async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            if (authToken && !endpoint.includes('register') && !endpoint.includes('login')) {
                headers['Authorization'] = `Bearer ${authToken}`;
                console.log('Using auth token:', authToken.substring(0, 20) + '...');
            }

            console.log(`API Call: ${options.method || 'GET'} ${url}`);
            console.log('Headers:', headers);
            if (options.body) {
                console.log('Request body:', JSON.parse(options.body));
            }

            try {
                const response = await fetch(url, { ...options, headers });
                const data = await response.json();
                
                console.log(`Response status: ${response.status}`);
                console.log('Response data:', data);
                
                if (!response.ok) {
                    throw new Error(data.message || data.error || `HTTP ${response.status}: Request failed`);
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }


        // Authentication
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const data = await apiCall('/login/', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                
                if (!data.verified) {
                    showAlert('Please verify your email before logging in.', 'error');
                    console.log('User email not verified');
                    return;
                }
                
                authToken = data.access;
                currentUser = {
                    username: data.username,
                    role: data.role,
                    verified: data.verified
                };
                
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                showAlert('Login successful! Redirecting...', 'success');
                setTimeout(() => {
                    window.location.href = '/home/';
                }, 1500);
                
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const role = document.getElementById('registerRole').value;
            
            try {
                await apiCall('/register/', {
                    method: 'POST',
                    body: JSON.stringify({ username, email, password, role })
                });
                
                showAlert('Account created! Please check your email for verification.', 'success');
                showLogin();
                document.getElementById('registerFormElement').reset();
                
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function handleLogout() {
            try {
                await apiCall('/logout/', { method: 'POST' });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            
            showAuthSection();
            showAlert('Signed out successfully', 'info');
        }

        // UI Navigation
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showAuthSection() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('userRole').textContent = currentUser.role;
            
            if (currentUser.role === 'Admin') {
                document.getElementById('adminTab').classList.remove('hidden');
            }
            
            loadSweets();
        }

        function switchTab(tabName) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');
            
            if (tabName === 'admin') {
                loadAdminSweets();
            }
        }

        // Sweet Management
        async function loadSweets() {
            try {
                const sweets = await apiCall('/api/sweets/');
                displaySweets(sweets, 'sweetsGrid');
            } catch (error) {
                showAlert('Failed to load sweets: ' + error.message, 'error');
            }
        }

        async function loadAdminSweets() {
            try {
                const sweets = await apiCall('/api/sweets/');
                displayAdminSweets(sweets, 'adminSweetsGrid');
            } catch (error) {
                showAlert('Failed to load sweets: ' + error.message, 'error');
            }
        }

        function displaySweets(sweets, containerId) {
            const container = document.getElementById(containerId);
            
            if (sweets.length === 0) {
                container.innerHTML = '<div class="empty-state">No sweets available</div>';
                return;
            }
            
            container.innerHTML = sweets.map(sweet => `
                <div class="sweet-card">
                    <h3>${sweet.name}</h3>
                    <div class="sweet-info">
                        <span class="sweet-tag">${sweet.category}</span>
                        <span class="sweet-tag price">‚Çπ${sweet.price}</span>
                        <span class="sweet-tag ${sweet.quantity < 5 ? 'stock-low' : ''}">
                            Stock: ${sweet.quantity}
                        </span>
                    </div>
                    <div class="sweet-actions">
                        <button class="btn btn-primary" onclick="purchaseSweet(${sweet.id})" 
                                ${sweet.quantity === 0 ? 'disabled' : ''}>
                            ${sweet.quantity === 0 ? 'Out of Stock' : 'Purchase'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayAdminSweets(sweets, containerId) {
            const container = document.getElementById(containerId);
            
            if (sweets.length === 0) {
                container.innerHTML = '<div class="empty-state">No sweets available</div>';
                return;
            }
            
            container.innerHTML = sweets.map(sweet => `
                <div class="sweet-card">
                    <h3>${sweet.name}</h3>
                    <div class="sweet-info">
                        <span class="sweet-tag">${sweet.category}</span>
                        <span class="sweet-tag price">‚Çπ${sweet.price}</span>
                        <span class="sweet-tag ${sweet.quantity < 5 ? 'stock-low' : ''}">
                            Stock: ${sweet.quantity}
                        </span>
                    </div>
                    <div class="sweet-actions">
                        <button class="btn btn-primary" onclick="editSweet(${sweet.id}, '${sweet.name}', '${sweet.category}', ${sweet.price}, ${sweet.quantity})">
                            Edit
                        </button>
                        <button class="btn btn-success" onclick="openRestockModal(${sweet.id})">
                            Restock
                        </button>
                        <button class="btn btn-danger" onclick="deleteSweet(${sweet.id})">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function purchaseSweet(sweetId) {
            try {
                await apiCall(`/api/sweets/${sweetId}/purchase/`, { method: 'POST' });
                showAlert('Sweet purchased successfully!', 'success');
                loadSweets();
                
                // Refresh admin view if active
                if (!document.getElementById('adminTab').classList.contains('hidden') && 
                    document.querySelector('[data-tab="admin"]').classList.contains('active')) {
                    loadAdminSweets();
                }
                
            } catch (error) {
                showAlert('Purchase failed: ' + error.message, 'error');
            }
        }

        // Search
        async function performSearch() {
            const name = document.getElementById('searchName').value;
            const category = document.getElementById('searchCategory').value;
            const minPrice = document.getElementById('minPrice').value;
            const maxPrice = document.getElementById('maxPrice').value;
            
            const params = new URLSearchParams();
            if (name) params.append('name', name);
            if (category) params.append('category', category);
            if (minPrice) params.append('min_price', minPrice);
            if (maxPrice) params.append('max_price', maxPrice);
            
            try {
                const sweets = await apiCall(`/api/sweets/search/?${params.toString()}`);
                displaySweets(sweets, 'searchResults');
            } catch (error) {
                showAlert('Search failed: ' + error.message, 'error');
            }
        }

        // Admin Functions
        async function handleAddSweet(e) {
            e.preventDefault();
            
            const name = document.getElementById('sweetName').value;
            const category = document.getElementById('sweetCategory').value;
            const price = document.getElementById('sweetPrice').value;
            const quantity = document.getElementById('sweetQuantity').value;
            
            try {
                await apiCall('/api/sweets/', {
                    method: 'POST',
                    body: JSON.stringify({ name, category, price, quantity })
                });
                
                closeModal('addSweetModal');
                showAlert('Sweet added successfully!', 'success');
                loadSweets();
                loadAdminSweets();
                document.getElementById('addSweetForm').reset();
                
            } catch (error) {
                showAlert('Failed to add sweet: ' + error.message, 'error');
            }
        }

        function editSweet(id, name, category, price, quantity) {
            document.getElementById('editSweetId').value = id;
            document.getElementById('editSweetName').value = name;
            document.getElementById('editSweetCategory').value = category;
            document.getElementById('editSweetPrice').value = price;
            document.getElementById('editSweetQuantity').value = quantity;
            openModal('editSweetModal');
        }

        async function handleEditSweet(e) {
            e.preventDefault();
            
            const id = document.getElementById('editSweetId').value;
            const name = document.getElementById('editSweetName').value;
            const category = document.getElementById('editSweetCategory').value;
            const price = document.getElementById('editSweetPrice').value;
            const quantity = document.getElementById('editSweetQuantity').value;
            
            try {
                await apiCall(`/api/sweets/${id}/`, {
                    method: 'PUT',
                    body: JSON.stringify({ name, category, price, quantity })
                });
                
                closeModal('editSweetModal');
                showAlert('Sweet updated successfully!', 'success');
                loadSweets();
                loadAdminSweets();
                
            } catch (error) {
                showAlert('Failed to update sweet: ' + error.message, 'error');
            }
        }

        function openRestockModal(sweetId) {
            document.getElementById('restockSweetId').value = sweetId;
            openModal('restockModal');
        }

        async function handleRestock(e) {
            e.preventDefault();
            
            const id = document.getElementById('restockSweetId').value;
            const quantity = document.getElementById('restockQuantity').value;
            
            try {
                await apiCall(`/api/sweets/${id}/restock/`, {
                    method: 'POST',
                    body: JSON.stringify({ quantity })
                });
                
                closeModal('restockModal');
                showAlert('Sweet restocked successfully!', 'success');
                loadSweets();
                loadAdminSweets();
                document.getElementById('restockForm').reset();
                
            } catch (error) {
                showAlert('Failed to restock sweet: ' + error.message, 'error');
            }
        }

        async function deleteSweet(sweetId) {
            if (!confirm('Are you sure you want to delete this sweet?')) return;
            
            try {
                await apiCall(`/api/sweets/${sweetId}/`, { method: 'DELETE' });
                showAlert('Sweet deleted successfully!', 'success');
                loadSweets();
                loadAdminSweets();
                
            } catch (error) {
                showAlert('Failed to delete sweet: ' + error.message, 'error');
            }
        }

        // Modal Management
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }