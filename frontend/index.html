<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Biskut - Sweet Shop</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/index.css' %}">
</head>
<body>
<div class="container">
  <!-- Header -->
  <div class="header">
    <h1>üç¨ Biskut</h1>
    <p>Your Sweet Shop Management System</p>
  </div>

  <!-- Alerts -->
  <div id="alertContainer"></div>

  <!-- Authentication Section -->
  <div id="authSection">
    <!-- Login Form -->
    <div id="loginForm" class="card auth-card">
      <h2 class="text-center mb-4">Welcome Back</h2>
      <form id="loginFormElement">
        <div class="form-group">
          <label for="loginUsername">Username</label>
          <input type="text" id="loginUsername" required>
        </div>
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" required>
        </div>
        <button type="submit" class="btn btn-primary btn-full">Sign In</button>
      </form>
      <p class="text-center mt-4">
        Don't have an account? 
        <a href="#" id="showRegister" class="link">Create one</a>
      </p>
    </div>

    <!-- Register Form -->
    <div id="registerForm" class="card auth-card hidden">
      <h2 class="text-center mb-4">Create Account</h2>
      <form id="registerFormElement">
        <div class="form-group">
          <label for="registerUsername">Username</label>
          <input type="text" id="registerUsername" required>
        </div>
        <div class="form-group">
          <label for="registerEmail">Email</label>
          <input type="email" id="registerEmail" required>
        </div>
        <div class="form-group">
          <label for="registerPassword">Password</label>
          <input type="password" id="registerPassword" required>
        </div>
          <div class="form-group hidden">
              <label for="registerRole">Role</label>
            <select id="registerRole">
                <option value="Customer" selected>Customer</option>
                <option value="Admin">Admin</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary btn-full">Create Account</button>
      </form>
      <p class="text-center mt-4">
        Already have an account? 
        <a href="#" id="showLogin" class="link">Sign in</a>
      </p>
    </div>
  </div>

  <!-- Main Application (hidden until login) -->
  <div id="mainApp" class="hidden">
    <div class="user-bar">
      <div class="user-info">
        <h3>Welcome, <span id="userName"></span></h3>
        <p>Role: <span id="userRole"></span></p>
      </div>
      <button id="logoutBtn" class="btn btn-secondary">Sign Out</button>
    </div>

    <!-- Navigation -->
    <div class="nav">
      <button class="nav-item active" id="allSweetsBtn">All Sweets</button>
      <button class="nav-item" id="searchBtn">Search</button>
    </div>

    <!-- Content Grid -->
    <div class="grid" id="sweetsGrid"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const authSection = document.getElementById("authSection");
  const mainApp = document.getElementById("mainApp");
  const userName = document.getElementById("userName");
  const userRole = document.getElementById("userRole");
  const alertContainer = document.getElementById("alertContainer");
  const sweetsGrid = document.getElementById("sweetsGrid");

  // Show alert
  function showAlert(msg, isError=true) {
    // Remove old alerts
    alertContainer.innerHTML = "";
    const div = document.createElement("div");
    div.className = `alert ${isError ? 'error' : 'success'}`;
    div.textContent = msg;
    alertContainer.appendChild(div);
    setTimeout(()=> div.remove(), 4000);
  }

  // Show main app
  function showApp(user) {
    authSection.classList.add("hidden");
    mainApp.classList.remove("hidden");
    userName.textContent = user.username;
    userRole.textContent = user.role;
    loadSweets();
  }

  // Show login form
  function showLogin() {
    authSection.classList.remove("hidden");
    mainApp.classList.add("hidden");
    document.getElementById("registerForm").classList.add("hidden");
    document.getElementById("loginForm").classList.remove("hidden");
  }

  // Check existing login
  const storedUser = localStorage.getItem("user");
  if (storedUser && localStorage.getItem("access")) {
    showApp(JSON.parse(storedUser));
  }

  // Login
  document.getElementById("loginFormElement").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const username = document.getElementById("loginUsername").value;
    const password = document.getElementById("loginPassword").value;
    try {
      const res = await fetch("/api/login/", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      if(res.ok){
        localStorage.setItem("access", data.access);
        localStorage.setItem("refresh", data.refresh);
        localStorage.setItem("user", JSON.stringify({username:data.username, role:data.role}));
        showApp({username:data.username, role:data.role});
      } else {
        showAlert(data.error || "Login failed");
      }
    } catch(err){
      console.error(err);
      showAlert("Login error");
    }
  });
  
  // Register
  document.getElementById("registerFormElement").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const username = document.getElementById("registerUsername").value;
    const email = document.getElementById("registerEmail").value;
    const password = document.getElementById("registerPassword").value;
    const role = document.getElementById("registerRole").value;
    try {
      const res = await fetch("/api/register/", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ username, email, password, role })
      });
      const data = await res.json();
      if(res.ok){
        showAlert("Registration successful!", false);
        showLogin();
      } else {
        showAlert(JSON.stringify(data));
      }
    } catch(err){
      console.error(err);
      showAlert("Register error");
    }
  });

  // Toggle forms
  document.getElementById("showRegister")?.addEventListener("click", (e)=>{
    e.preventDefault();
    document.getElementById("loginForm").classList.add("hidden");
    document.getElementById("registerForm").classList.remove("hidden");
  });

  document.getElementById("showLogin")?.addEventListener("click", (e)=>{
    e.preventDefault();
    showLogin();
  });

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", async ()=>{
    const refresh = localStorage.getItem("refresh");
    try {
      await fetch("/api/logout/", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ refresh })
      });
    } catch(err){
      console.error("Logout error", err);
    } finally {
      localStorage.clear();
      showLogin();
    }
  });

  // Load sweets (placeholder, replace with actual fetch)
 <!-- inside your existing <script> DOMContentLoaded -->

// Load sweets with improved UI
async function loadSweets() {
  sweetsGrid.innerHTML = "";
  try {
    const res = await fetch("/api/sweets/", {
      method:"GET",
      headers:{ "Authorization": `Bearer ${localStorage.getItem("access")}` }
    });
    const data = await res.json();
    if(res.ok && Array.isArray(data)){
      data.forEach(sweet=>{
        const div = document.createElement("div");
        div.className = "card sweet-card";

        // Image placeholder URL based on sweet name
       // Fixed size Unsplash image for sweets
const imageUrl = `https://images.unsplash.com/photo-1578985545062-69928b1d9587?crop=entropy&cs=tinysrgb&fit=crop&h=200&w=200`;


        div.innerHTML = `
          <img src="${imageUrl}" style="text-align:center;border-radius:10px;margin:auto;" alt="${sweet.name}">
          <h4>${sweet.name}</h4>
          <p>Category: ${sweet.category}</p>
          <p>Price: $${sweet.price}</p>
          <p>Available: ${sweet.quantity}</p>
        `;

        // Customer: Purchase Section
        if(JSON.parse(localStorage.getItem("user")).role === "Customer"){
          const purchaseDiv = document.createElement("div");
          purchaseDiv.className = "purchase-section";
          purchaseDiv.innerHTML = `
            <input type="number" min="1" max="${sweet.quantity}" value="1" class="purchase-qty">
            <button class="btn btn-primary btn-small">Purchase</button>
          `;
          div.appendChild(purchaseDiv);

          const purchaseBtn = purchaseDiv.querySelector("button");
          purchaseBtn.addEventListener("click", async ()=>{
            const qty = parseInt(purchaseDiv.querySelector("input").value);
            if(qty < 1 || qty > sweet.quantity){
              showAlert("Invalid quantity");
              return;
            }
            try {
              const res = await fetch(`/api/sweets/${sweet.id}/purchase/`, {
                method:"POST",
                headers:{
                  "Content-Type":"application/json",
                  "Authorization": `Bearer ${localStorage.getItem("access")}`
                },
                body: JSON.stringify({quantity: qty})
              });
              const data = await res.json();
              if(res.ok){
                showAlert(`Purchased ${qty} ${sweet.name}`, false);
                loadSweets(); // refresh grid
              } else {
                showAlert(data.error || "Purchase failed");
              }
            } catch(err){
              console.error(err);
              showAlert("Purchase error");
            }
          });
        }

        // Admin: Delete & Restock
        if(JSON.parse(localStorage.getItem("user")).role === "Admin"){
          const adminDiv = document.createElement("div");
          adminDiv.className = "admin-section";
          adminDiv.innerHTML = `
            <button class="btn btn-danger btn-small">Delete</button>
            <input type="number" min="1" placeholder="Restock qty" class="restock-qty">
            <button class="btn btn-secondary btn-small">Restock</button>
          `;
          div.appendChild(adminDiv);

          // Delete button
          adminDiv.querySelector(".btn-danger").addEventListener("click", async ()=>{
            if(!confirm(`Delete ${sweet.name}?`)) return;
            try {
              const res = await fetch(`/api/sweets/${sweet.id}/delete/`, {
                method:"DELETE",
                headers:{
                  "Authorization": `Bearer ${localStorage.getItem("access")}`
                }
              });
              if(res.ok){
                showAlert(`${sweet.name} deleted`, false);
                loadSweets();
              } else {
                const data = await res.json();
                showAlert(data.error || "Delete failed");
              }
            } catch(err){
              console.error(err);
              showAlert("Delete error");
            }
          });

          // Restock button
          adminDiv.querySelector(".btn-secondary").addEventListener("click", async ()=>{
            const qty = parseInt(adminDiv.querySelector(".restock-qty").value);
            if(qty < 1){
              showAlert("Enter valid restock quantity");
              return;
            }
            try {
              const res = await fetch(`/inventory/${sweet.id}/restock`, {
                method:"POST",
                headers:{
                  "Content-Type":"application/json",
                  "Authorization": `Bearer ${localStorage.getItem("access")}`
                },
                body: JSON.stringify({quantity: qty})
              });
              const data = await res.json();
              if(res.ok){
                showAlert(`${sweet.name} restocked by ${qty}`, false);
                loadSweets();
              } else {
                showAlert(data.error || "Restock failed");
              }
            } catch(err){
              console.error(err);
              showAlert("Restock error");
            }
          });
        }

        sweetsGrid.appendChild(div);
      });
    } else {
      showAlert("Failed to load sweets");
    }
  } catch(err){
    console.error(err);
    showAlert("Error loading sweets");
  }
}

});
</script>
<!-- Add this modal div inside <body> but outside container -->
<div id="purchaseModal" class="hidden modal">
  <div class="modal-content">
    <span id="closeModal" class="close">&times;</span>
    <h3 id="modalSweetName"></h3>
    <p>Price: $<span id="modalSweetPrice"></span></p>
    <div class="form-group">
      <label>Quantity:</label>
      <input type="number" id="modalQty" min="1" value="1">
    </div>
    <div class="form-group">
      <label>Payment Method:</label>
      <select id="modalPayment">
        <option value="cod">Cash on Delivery</option>
        <option value="upi">UPI</option>
      </select>
    </div>
    <div id="upiImageContainer" class="hidden">
      <img src="{% static 'image/upi.png' %}" alt="UPI" style="width:150px;margin-top:10px;">
    </div>
    <button id="confirmPurchase" class="btn btn-primary btn-full">Confirm Purchase</button>
  </div>
</div>
</body>
</html>
